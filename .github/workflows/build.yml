name: Build Libcurl Static SSL
on: [workflow_dispatch]

jobs:
  build-curl:
    runs-on: windows-latest
    steps:
      # 1. Pastikan checkout repository CURL dengan benar ke root
      - name: Checkout Curl Source
        uses: actions/checkout@v4
        with:
          repository: curl/curl
          fetch-depth: 1
          # Jangan gunakan parameter 'path' agar file langsung ada di root

      # 5. Compile
      - name: Configure and Build with CMake
        shell: cmd
        run: |
          vcpkg install zlib:x64-windows
          :: 1. Inisialisasi Environment VS
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"

          :: 2. Buat folder build
          mkdir build
          cd build

          :: 3. Jalankan CMake dengan Toolchain vcpkg yang benar
          :: PENTING: Gunakan -DVCPKG_TARGET_TRIPLET=x64-windows-static
          cmake .. -G "Visual Studio 17 2022" -A x64 ^
            -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" ^
            -DVCPKG_TARGET_TRIPLET=x64-windows-static ^
            -DCURL_USE_OPENSSL=ON ^
            -DCURL_ZLIB=ON ^
            -DBUILD_SHARED_LIBS=ON ^
            -DBUILD_CURL_EXE=ON ^
            -DCURL_STATIC_CRT=ON ^
            -DCMAKE_SHARED_LINKER_FLAGS="/EXPORT:SSL_get_version /EXPORT:SSL_get_cipher"

          :: 4. Build Project
          cmake --build . --config Release
          
      - name: List Files for Debug
        run: |
          dur build
          dir build/src/Release
          dir build/lib/Release

          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-cmake-static
          path: |
            build/lib/Release/libcurl.dll
            build/src/Release/curl.exe
