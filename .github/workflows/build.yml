name: Build Libcurl Static SSL
on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout Curl
        uses: actions/checkout@v4
        with:
          repository: curl/curl
          fetch-depth: 1

      - name: Setup vcpkg
        run: |
          vcpkg install openssl:x64-windows-static zlib:x64-windows-static

      - name: Configure and Build
        shell: cmd
        run: |
          :: 1. Inisialisasi Environment Visual Studio
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          
          :: 2. Masuk ke direktori winbuild secara eksplisit dari root checkout
          cd %GITHUB_WORKSPACE%\winbuild
          if %errorlevel% neq 0 exit /b %errorlevel%

          :: 3. Jalankan NMAKE dengan path SSL yang sudah di-resolve oleh vcpkg
          :: Perhatikan: vcpkg_installed biasanya ada di root repo
          nmake /f Makefile.vc mode=dll VC=17 WITH_SSL=static SSL_PATH="%GITHUB_WORKSPACE%\vcpkg_installed\x64-windows-static" MACHINE=x64

      - name: List Files for Debug
        run: |
          dir
          dir winbuild
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-with-static-ssl
          path: builds/libcurl-vc17-x64-release-dll-ssl-static-ipv6-sspi/*
