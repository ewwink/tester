name: Build Libcurl Static SSL
on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout Curl 8.16.0
        uses: actions/checkout@v4
        with:
          repository: curl/curl
          ref: curl-8_16_0  # Kembali ke versi yang masih punya winbuild
          fetch-depth: 1

      - name: Restore vcpkg cache
        id: cache-vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/vcpkg_installed
            C:/vcpkg/installed
            ${{ env.LOCALAPPDATA }}/vcpkg/archives
          key: ${{ runner.os }}-vcpkg-openssl-zlib-v1
          restore-keys: |
            ${{ runner.os }}-vcpkg-

      - name: Install Dependencies
        if: steps.cache-vcpkg.outputs.cache-hit != 'true'
        run: |
          vcpkg install openssl:x64-windows-static zlib:x64-windows-static

      - name: Force Export SSL Functions
        shell: powershell
        run: |
          # Menambahkan fungsi SSL ke tabel export libcurl.dll
          $defFile = "lib/libcurl.def"
          if (Test-Path $defFile) {
              Add-Content -Path $defFile -Value "  SSL_get_version"
              Add-Content -Path $defFile -Value "  SSL_get_cipher"
              Write-Host "Fungsi SSL berhasil ditambahkan ke .def file."
          }

      - name: Configure and Build
        shell: cmd
        run: |
          :: 1. Inisialisasi Environment VS
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          
          :: 2. Tentukan Path vcpkg (Lokasi library .lib)
          set "VCPKG_ROOT=%GITHUB_WORKSPACE%\vcpkg_installed\x64-windows-static"
          
          :: 3. Masuk ke winbuild
          cd winbuild
          
          :: 4. Jalankan NMAKE dengan ACKNOWLEDGE flag
          nmake /f Makefile.vc mode=dll VC=17 WITH_SSL=static WITH_ZLIB=static ^
            SSL_PATH="%VCPKG_ROOT%" ZLIB_PATH="%VCPKG_ROOT%" ^
            MACHINE=x64 CURL_ACKNOWLEDGE_DEPRECATION=1

      - name: Verify Export (Debug)
        shell: cmd
        run: |
          :: Cek apakah SSL_get_version benar-benar ada di dalam DLL
          dumpbin /exports builds\libcurl-vc17-x64-release-dll-ssl-static-zlib-static-ipv6-sspi\bin\libcurl.dll | findstr "SSL_get_version"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-8.16.0-custom
          path: builds/libcurl-vc17-x64-release-dll-ssl-static-zlib-static-ipv6-sspi/bin/*

