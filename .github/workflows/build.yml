name: Build Libcurl Static SSL
on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install MSYS2 + dependencies
        shell: pwsh
        run: |
          choco install msys2 --no-progress
          # Refresh environment
          $env:Path += ";C:\tools\msys64\usr\bin"
          # Install packages
          C:\tools\msys64\usr\bin\bash.exe -lc "
            pacman -Syu --noconfirm
            pacman -S --noconfirm --needed \
              base-devel mingw-w64-x86_64-toolchain \
              mingw-w64-x86_64-openssl \
              autoconf automake libtool pkgconf \
              mingw-w64-x86_64-perl
          "

      - name: Download curl source (latest)
        shell: pwsh
        run: |
          $curlVersion = "8.10.1"   # ganti dengan versi terbaru, cek https://curl.se/download.html
          Invoke-WebRequest -Uri "https://curl.se/download/curl-${curlVersion}.tar.gz" -OutFile "curl.tar.gz"
          tar -xzf curl.tar.gz
          mv curl-${curlVersion} curl-src

      - name: Build OpenSSL static (jika ingin versi lebih baru dari MSYS2)
        shell: msys2 {0}
        working-directory: .
        run: |
          # Optional: build OpenSSL sendiri jika MSYS2 version terlalu lama
          curl -L -o openssl-3.3.2.tar.gz https://www.openssl.org/source/openssl-3.3.2.tar.gz
          tar -xzf openssl-3.3.2.tar.gz
          cd openssl-3.3.2

          perl Configure VC-WIN64A no-shared --prefix=$PWD/install --openssldir=$PWD/install
          nmake
          nmake install

          echo "OPENSSL_DIR=$PWD/install" >> $GITHUB_ENV

      - name: Build libcurl with static OpenSSL â†’ single DLL
        shell: msys2 {0}
        working-directory: curl-src
        env:
          # Jika pakai OpenSSL dari MSYS2, comment baris OPENSSL_DIR di bawah
          # OPENSSL_DIR: /mingw64
          OPENSSL_DIR: ${{ env.OPENSSL_DIR }}
        run: |
          # Pastikan di shell 64-bit
          . /etc/profile
          export PATH="/mingw64/bin:$PATH"

          # Optional: tambah path openssl custom
          # export PKG_CONFIG_PATH="$OPENSSL_DIR/lib/pkgconfig:$PKG_CONFIG_PATH"
          # export LDFLAGS="-L$OPENSSL_DIR/lib"
          # export CFLAGS="-I$OPENSSL_DIR/include"

          autoreconf -fi

          ./configure \
            --build=x86_64-w64-mingw32 \
            --host=x86_64-w64-mingw32 \
            --prefix=/mingw64 \
            --enable-shared \
            --disable-static \
            --with-openssl \
            --without-zlib \     # optional, kalau tidak butuh compression
            --without-libidn2 \
            --without-libssh2 \
            --enable-optimize \
            --enable-verbose

          # Kalau mau lebih agresif static-link OpenSSL
          # Tambahkan LDFLAGS="-static-libgcc -Wl,-Bstatic -lssl -lcrypto -Wl,-Bdynamic"

          make -j$(nproc)
          make install

      - name: Check dependencies (pastikan hampir tidak ada external SSL)
        shell: msys2 {0}
        run: |
          /mingw64/bin/dependencywalker /mingw64/bin/curl.exe || true
          /mingw64/bin/ldd /mingw64/bin/libcurl-4.dll || true

      - name: Upload hasil
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-single-dll
          path: |
            curl-src/lib/.libs/libcurl-*.dll
            /mingw64/bin/libcurl-*.dll
