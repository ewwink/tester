name: Build Libcurl Static SSL
on: [push, workflow_dispatch]

jobs:
  prepare-deps:
    runs-on: windows-latest
    steps:
      - name: Restore vcpkg cache
        uses: actions/cache@v4
        with:
          path: |
            C:/vcpkg/installed
            ${{ github.workspace }}/vcpkg_installed
          key: ${{ runner.os }}-vcpkg-openssl-zlib-nghttp2-v1

      - name: Install vcpkg and Dependencies
        run: |
          vcpkg install openssl:x64-windows-static `
                        zlib:x64-windows-static `
                        nghttp2:x64-windows-static `
                        brotli:x64-windows-static `
                        zstd:x64-windows-static
      - name: Checkout Curl 8.16.0
        uses: actions/checkout@v4
        with:
          repository: curl/curl
          ref: curl-8_16_0  # Kembali ke versi yang masih punya winbuild
          fetch-depth: 1
        
  build-curl:
    needs: prepare-deps
    runs-on: windows-latest
    steps:          
      - name: Install Dependencies Restore vcpkg cache (Read Only)
        uses: actions/cache/restore@v4
        with:
          path: |
            C:/vcpkg/installed
            ${{ github.workspace }}/vcpkg_installed
          key: ${{ runner.os }}-vcpkg-openssl-zlib-nghttp2-v1

      - name: Force Export SSL Functions
        shell: powershell
        run: |
          # Menambahkan fungsi SSL ke tabel export libcurl.dll
          $defFile = "lib/libcurl.def"
          if (Test-Path $defFile) {
              Add-Content -Path $defFile -Value "`nSSL_get_version"
              Add-Content -Path $defFile -Value "`nSSL_get_cipher"
              Write-Host "Fungsi SSL berhasil ditambahkan ke .def file."
          }

      - name: Configure and Build
        shell: cmd
        run: |
          :: 1. Inisialisasi Environment VS
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          set "VCPKG_ROOT=C:\vcpkg\installed\x64-windows-static"
          
          :: Debug: Pastikan zlib.h ada di sana
          if not exist "%VCPKG_ROOT%\include\zlib.h" (
            echo "ERROR: zlib.h tidak ditemukan di %VCPKG_ROOT%\include"
            dir /s "C:\vcpkg\installed\zlib.h"
            exit /b 1
          )

          :: 3. Masuk ke winbuild
          cd winbuild
          if errorlevel 1 exit /b 1
          
          :: 4. Jalankan NMAKE
          :: PENTING: Gunakan tanda kutip pada PATH jika ada spasi
          set "LDFLAGS=/OPT:REF /OPT:ICF /EXPORT:SSL_get_version /EXPORT:SSL_get_cipher"
          nmake /f Makefile.vc mode=dll VC=17 WITH_SSL=static WITH_ZLIB=static WITH_NGHTTP2=static ^
            WITH_BROTLI=static WITH_ZSTD=static ^
            ENABLE_IDN=no ENABLE_LDAP=no ENABLE_IPV6=yes ^
            DEBUG=no GEN_PDB=no ^
            SSL_PATH="%VCPKG_ROOT%" ZLIB_PATH="%VCPKG_ROOT%" NGHTTP2_PATH="%VCPKG_ROOT%" ^
            BROTLI_PATH="%VCPKG_ROOT%" ZSTD_PATH="%VCPKG_ROOT%" ^
            MACHINE=x64 WINBUILD_ACKNOWLEDGE_DEPRECATED=yes
            

      - name: Verify Export (Debug)
        shell: cmd
        run: |
          dir builds
          dir builds\libcurl-vc17-x64-release-dll-ssl-static-zlib-static-ipv6-sspi-nghttp2-static\bin\
          :: Cek apakah SSL_get_version benar-benar ada di dalam DLL
          :: dumpbin /exports builds\libcurl-vc17-x64-release-dll-ssl-static-zlib-static-ipv6-sspi\bin\libcurl.dll | findstr "SSL_get_version"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-8.16.0-custom
          path: builds/libcurl-vc17-x64-release-dll-ssl-static-zlib-static-ipv6-sspi-nghttp2-static/bin/*

