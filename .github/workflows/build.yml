name: Build libcurl with OpenSSL (TLS 1.3)

on:
  workflow_dispatch: # Jalankan manual dari tab "Actions" di GitHub

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg
          ./vcpkg/bootstrap-vcpkg.bat

      - name: Install Curl with OpenSSL & HTTP2
        shell: pwsh
        run: |
          # Kita paksa menggunakan OpenSSL (bukan Schannel) dan nghttp2
          ./vcpkg/vcpkg install "curl[openssl,http2]" --triplet x64-windows

      - name: Prepare Artifacts
        shell: pwsh
        run: |
          # Buat folder untuk menampung semua DLL yang dibutuhkan
          New-Item -ItemType Directory -Force -Path ./output
          
          # Lokasi hasil build vcpkg
          $binPath = "./vcpkg/installed/x64-windows/bin"
          
          # Copy libcurl dan dependensinya (OpenSSL, Zlib, nghttp2)
          Copy-Item "$binPath/libcurl.dll" -Destination "./output/"
          Copy-Item "$binPath/libcrypto-3-x64.dll" -Destination "./output/" -ErrorAction SilentlyContinue
          Copy-Item "$binPath/libssl-3-x64.dll" -Destination "./output/" -ErrorAction SilentlyContinue
          Copy-Item "$binPath/zlib1.dll" -Destination "./output/" -ErrorAction SilentlyContinue
          Copy-Item "$binPath/nghttp2.dll" -Destination "./output/" -ErrorAction SilentlyContinue

      - name: Upload Libcurl Bundle
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-openssl-x64
          path: ./output/*
